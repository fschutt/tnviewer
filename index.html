<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tats√§chliche Nutzung Viewer / Editor</title>
    <link rel="stylesheet" href="./js/leaflet/leaflet.css">
    <script src="./js/leaflet/leaflet.js"></script>
    <link rel="stylesheet" href="main.css">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script type="module">
      import init, {ui_render_entire_screen, load_nas_xml} from "./pkg/tnviewer.js";

      var map = null; // Leaflet object
      var projectdata = null; // project data
      var uidata = { // UI State
        popover_state: null,
        tab: null, 
        data_loaded: false,
      };
      var configuration = null; // default config object

      function replaceDataNasXML() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = ".xml";

        input.onchange = e => { 
            var file = e.target.files[0]; 
            var reader = new FileReader();
            reader.readAsText(file,'UTF-8');
            reader.onload = readerEvent => {
              var content = readerEvent.target.result;
              var array = new Uint8Array(content);
              var converted = load_nas_xml(array);
              projectdata = JSON.parse(converted);
              console.log(projectdata);
              alert("ok!");
            }
        }
        input.click();
    }

    function initializeOrUpdateMap() {
          var id = document.getElementById("mapboxtoken");
          if (!id) {
            return;
          }
          if (id.value.length == 0) {
            return;
          }
          var mapcontainer = document.getElementById("map");
          if (!mapcontainer) {
            return;
          }
          if (map == null || map == undefined || !map) {
            map = L.map('map').setView([53.2467, 13.6045], 10);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
          }
        }

    init()
      .then(() => { 
        var array = new Uint8Array();
        document.body.innerHTML = ui_render_entire_screen(array);
        initializeOrUpdateMap(); // add leaflet map
        replaceDataNasXML(); // test
        document.getElementById("__application-daten-laden-test-button").onclick = replaceDataNasXML;
      });
    </script>
  </head>
  <body>
  </body>
</html>
