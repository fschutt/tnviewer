<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tats√§chliche Nutzung Viewer / Editor</title>
    <link rel="stylesheet" href="./js/leaflet/leaflet.css">
    <script src="./js/leaflet/leaflet.js"></script>
    <link rel="stylesheet" href="main.css">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script type="module">

      import init, {
        ui_render_entire_screen, 
        load_nas_xml, 
        get_geojson_fuer_ebene
      } from "./pkg/tnviewer.js";

      var map = null; // Leaflet object
      var geojson_layers = [];
      var layers = null;
      var projectdata = null; // project data
      var uidata = { // UI State
        popover_state: null,
        tab: null, 
        data_loaded: false,
      };
      var configuration = {
        map: {
          basemap: "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
          dop_source: "https://isk.geobasis-bb.de/mapproxy/dop20c_wmts/service",
          dop_layers: "bebb_dop20c"
        },
        style: {
          AX_Flurstueck: {
            fillColor: "#aaccbb",
            outlineColor: "#ccbbaa",
            outlineThickness: "2",
            outlineDash: null,
            outlineOverprint: false,
          },
          AX_Gebaeude: {
            fillColor: "#aaccbb",
            outlineColor: "#ccbbaa",
            outlineThickness: "2",
            outlineDash: null,
            outlineOverprint: false,
          },
          AX_Landwirtschaft: {
            fillColor: "#aaccbb",
            outlineColor: "#ccbbaa",
            outlineThickness: "2",
            outlineDash: null,
            outlineOverprint: false,
          },
        }
      }; // default config object

      /*
      
        var overlays = {
            "Marker": marker,
            "Roads": roadsLayer
        };

        L.control.layers(baseLayers, overlays).addTo(map);
      */

      function replaceDataNasXML() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = ".xml";

        input.onchange = e => { 
            var file = e.target.files[0]; 
            var reader = new FileReader();
            reader.readAsText(file,'UTF-8');
            reader.onload = readerEvent => {

              var converted = load_nas_xml(readerEvent.target.result);
              projectdata = JSON.parse(converted);
              initializeOrUpdateMap();

              // remove old LeafLet layers
              for (var [layer_name, layer_obj] of Object.entries(geojson_layers)) {
                layer_obj.remove();
              }
              geojson_layers = [];
              for (var layer_name in configuration.style) {
                var geojson = JSON.parse(get_geojson_fuer_ebene(converted, layer_name));
                var layer_style = configuration.style[layer_name];
                var myLayer = L.geoJSON(geojson, {
                  "color": layer_style.outlineColor,
                  "fillColor": layer_style.fillColor,
                  "weight": layer_style.outlineThickness,
                  "opacity": 0.0
                });
                layers.addOverlay(myLayer, layer_name);
                myLayer.addTo(map);
                geojson_layers.push(myLayer);
              }
            }
        }
        input.click();
    }

    function initializeOrUpdateMap() {
        if (map == null || map == undefined || !map) {
          map = L.map('map', {
            zoomControl: false
          });
          map.setView([53.2467, 13.6045], 10);
          var basemap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          });
          var wms = L.tileLayer.wms(configuration.dop_source, {
              layers: configuration.dop_layers
          });
          var basemaps = {
            OSM: basemap,
            DOP: wms,
          };
          layers = L.control.layers(basemaps);
          layers.addTo(map);
          L.control.zoom({ position:'topright' }).addTo(map);
          basemaps.OSM.addTo(map);
        }
      }

    init()
      .then(() => { 
        document.body.innerHTML = ui_render_entire_screen(JSON.stringify(uidata));
        initializeOrUpdateMap(); // add leaflet map
        document.getElementById("__application-daten-laden-test-button").onclick = replaceDataNasXML;
      });
    </script>
  </head>
  <body>
  </body>
</html>
