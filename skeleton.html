<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tatsächliche Nutzung Viewer / Editor</title>
    <script type="module">
        window.configuration = {
          "map":{
              "basemap":"https://tile.openstreetmap.org/{z}/{x}/{y}.png",
              "dop_source":"https://isk.geobasis-bb.de/mapproxy/dop20c/service/wms?",
              "dop_layers":"bebb_dop20c",
              "dgm_source":"https://isk.geobasis-bb.de/mapproxy/dgm/service/wms?",
              "dgm_layers":"dgm"
          },
          "merge":{
              "stage1_maxdst_point":1.0,
              "stage1_maxdst_line":1.0,
              "stage2_maxdst_point":1.0,
              "stage2_maxdst_line":1.0,
              "stage3_maxdst_line":0.2,
              "stage3_maxdst_line2":2.0,
              "stage3_maxdeviation_followline":5.0
          },
          "pdf":{
              "grenzpunkt_svg":null,
              "pfeil_svg":null,
              "nordpfeil_svg":null,
              "gebauede_loeschen_svg":null,
              "ax_flur_stil":{
                "fill_color":"#000",
                "fill":false,
                "outline_color":"#ccc",
                "outline_thickness":3.0,
                "outline_dash":"5-5-5-5-5-5",
                "outline_overprint":true,
                "pattern_svg":null,
                "pattern_placement":null
              },
              "ax_bauraum_stil":{
                "fill_color":"#000",
                "fill":false,
                "outline_color":"#ff0000",
                "outline_thickness":3.0,
                "outline_dash":"5-5-5-5-5-5",
                "outline_overprint":true,
                "pattern_svg":null,
                "pattern_placement":null
              },
              "lagebez_mit_hsnr":{
                
              }
          },
          "style":{
              "ebenen_ordnung":[
                "b",
                "c",
                "d",
                "e",
                "f",
                "g",
                "h",
                "i",
                "j",
                "l",
                "m",
                "n",
                "o",
                "p",
                "q",
                "r",
                "s",
                "t",
                "u",
                "v",
                "w",
                "x",
                "y",
                "z",
                "za",
                "zb",
                "zc",
                "zd"
              ],
              "ebenen":{
                "b":{
                    "name":"AX_Flurstueck",
                    "fill_color":"#ccc",
                    "outline_color":"#000000",
                    "outline_thickness":2
                },
                "c":{
                    "name":"AX_Meer",
                    "fill_color":"#00ccab",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "d":{
                    "name":"AX_StehendesGewaesser",
                    "fill_color":"#00ccab",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "e":{
                    "name":"AX_Fliessgewaesser",
                    "fill_color":"#00ccab",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "f":{
                    "name":"AX_BauwerkImVerkehrsbereich",
                    "fill_color":"#008822",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "g":{
                    "name":"AX_SonstigesBauwerkOderSonstigeEinrichtung",
                    "fill_color":"#008822",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "h":{
                    "name":"AX_BauwerkOderAnlageFuerIndustrieUndGewerbe",
                    "fill_color":"#008822",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "i":{
                    "name":"AX_Turm",
                    "fill_color":"#008822",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "j":{
                    "name":"AX_Bauteil",
                    "fill_color":"#008822",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "k":{
                    "name":"AX_Gebaeude",
                    "fill_color":"#bdbdbd",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "l":{
                    "name":"AX_Gebaeude",
                    "fill_color":"#bdbdbd",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "m":{
                    "name":"AX_Bahnverkehr",
                    "fill_color":"#b8b8b8",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "n":{
                    "name":"AX_Platz",
                    "fill_color":"#b8b8b8",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "o":{
                    "name":"AX_Weg",
                    "fill_color":"#b8b8b8",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "p":{
                    "name":"AX_Strassenverkehr",
                    "fill_color":"#cccccc",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "q":{
                    "name":"AX_Friedhof",
                    "fill_color":"#638062",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "r":{
                    "name":"AX_SportFreizeitUndErholungsflaeche",
                    "fill_color":"#61a360",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "s":{
                    "name":"AX_FlaecheBesondererFunktionalerPraegung",
                    "fill_color":"#e364e1",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "t":{
                    "name":"AX_FlaecheGemischterNutzung",
                    "fill_color":"#648ae3",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "u":{
                    "name":"AX_TagebauGrubeSteinbruch",
                    "fill_color":"#9c9c9c",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "v":{
                    "name":"AX_Halde",
                    "fill_color":"#7a7463",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "w":{
                    "name":"AX_IndustrieUndGewerbeflaeche",
                    "fill_color":"#fcba03",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "x":{
                    "name":"AX_Wohnbauflaeche",
                    "fill_color":"#ffadbe",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "y":{
                    "name":"AX_UnlandVegetationsloseFlaeche",
                    "fill_color":"#d9d9d9",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "z":{
                    "name":"AX_Sumpf",
                    "fill_color":"#00a367",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "za":{
                    "name":"AX_Heide",
                    "fill_color":"#b8005c",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "zb":{
                    "name":"AX_Gehoelz",
                    "fill_color":"#03b800",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "zc":{
                    "name":"AX_Wald",
                    "fill_color":"#51ed4e",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "zd":{
                    "name":"AX_Landwirtschaft",
                    "fill_color":"#fff596",
                    "outline_color":"#000000",
                    "outline_thickness":1
                },
                "ze":{
                    "name":"AX_BauRaumOderBodenordnungsrecht",
                    "fill_color":"#ff0000",
                    "outline_color":"#000000",
                    "outline_thickness":1
                }
              }
          }
        };
    </script>

    <!--LEAFLET_CSS_LINK-->
    <!--LEAFLET_JS-->
    <!--LEAFLET_DRAW_JS-->
    <!--MAIN_CSS-->

    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script type="module">
    function base64ToArrayBuffer(base64) {
        var binaryString = atob(base64);
        var bytes = new Uint8Array(binaryString.length);
        for (var i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }
    window.base64ToArrayBuffer = base64ToArrayBuffer;

    // PUT_WASM_JS_HERE

    window.init = __wbg_init;

    var MARKER_NORMAL_WEBP = "";
    var MARKER_MIDDLE_WEBP = "";
    var RISS_COLOR = "blue";
    var AVOID_COLOR = "red";

    var drag_icon_normal_src = 'data:image/png;charset=utf-8;base64,' + MARKER_NORMAL_WEBP;
    var drag_icon_normal = L.icon({
        iconUrl: drag_icon_normal_src,
        iconSize: [20, 20],
    });

    var drag_icon_middle_src = 'data:image/png;charset=utf-8;base64,' + MARKER_MIDDLE_WEBP;
    var drag_icon_middle = L.icon({
        iconUrl: drag_icon_middle_src,
        iconSize: [30, 30],
    });

    var map = null;
    var search_geojson_layer = null;
    var geojson_layers = [];
    var geojson_repaint_layers = [];
    var leaflet_risse = {};
    var layers = null;
    var basemaps = null;
    var highlight_layer = null;
    var nutzung_einzeichnen_layer = null;
    var gebaeude_loeschen_layer = null;
    var current_edit_layer = null;
    var guideLayers = [];
    var rissgebiet_layer = null;
    var current_rissgebiet_layer = null;
    var active_rissgebiet = null;
    
    var defaultdate = new Date().getFullYear() + "-31-XXX";
    window.split_flurstuecke = null; // split XML NAS data
    window.projectdata = null; // project XML NAS data
    window.csv_data = null; // project CSV data
    window.uidata = { // UI State
      popover_state: null,
      tab: null, 
      tool: null,
      selected_edit_flst: "",
      secondary_content: false,
      render_out: null,
    };
    window.aenderungen = {
      gebaeude_loeschen: {},
      na_definiert: {},
      na_polygone_neu: {},
    };
    var datenow = new Date().toLocaleDateString("de-DE", { // you can use undefined as first argument
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });

    window.info = {
      antragsnr: defaultdate,
      katasteramt: "Uckermark",
      vermessungsstelle: "KVA Uckermark",
      erstellt_durch: "Felix Schütt",
      beruf_kuerzel: "GM",
      gemeinde: "Carmzow-Wallmow",
      gemarkung: "Cremzow",
      bearbeitung_beendet_am: datenow,
      alkis_aktualitaet: datenow,
      orthofoto_datum: "18.04.2020",
      gis_feldbloecke_datum: "11.02.2022",
    };
    window.risse = {};

    // INJECT_SELECT_MAP_JS

    function highlightPolygon(poly) {

      let bounds = JSON.parse(get_fit_bounds(JSON.stringify(poly)));
      map.fitBounds(bounds);

      if (highlight_layer) {
        map.removeLayer(highlight_layer);
        highlight_layer = null;
      }

      let geojson = JSON.parse(get_geojson_polygon(JSON.stringify(poly)));
      var myLayer = null;
      if (L.geoJson) {
        myLayer = L.geoJson(geojson, {
          "style": {
            "color": "red",
            "fillColor": "transparent",
            "weight": 5,
            "opacity": 1.0,
            "fillOpacity": 0.3,
          }
        });
      } else if (L.geoJSON) {
        myLayer = L.geoJSON(geojson, {
          "style": {
            "color": "red",
            "fillColor": "transparent",
            "weight": 5,
            "opacity": 1.0,
            "fillOpacity": 0.3,
          }
        });
      }

      if (myLayer == null) {
        return;
      }

      myLayer.addTo(map);
      highlight_layer = myLayer;
    }

    function editKonfigurationInputFile(e) {
      if (e.target.files.length < 1) {
        return;
      }
      
      var textfield_type = e.target.dataset.konfigurationTextfield;
      var style_id = e.target.dataset.konfigurationStyleId;
      var file = e.target.files[0];
      var reader = new FileReader();
      reader.readAsText(file,'UTF-8');
      reader.onload = readerEvent => {
        var svg = readerEvent.target.result;
        var d = document.getElementById("__application_pdf_nutzungsart_pattern_" + style_id);
        d.value = btoa(svg);
        d.dispatchEvent(new Event('change'));
      }
    }

    window.editKonfigurationInputFile = editKonfigurationInputFile;

    function konfigurationLayerAlle(event) {
      var l = edit_konfiguration_layer_alle(
        JSON.stringify(window.configuration), 
        JSON.stringify(window.xml_data)
      );
      var json = JSON.parse(l);
      if (json.result) {
        window.configuration = json.result;
      }
      window.layer_log = json.log;
      replacePopOver("config");
    }

    window.konfigurationLayerAlle = konfigurationLayerAlle;

    function konfigurationLayerNeu(event) {
      var konfiguration_type = event.target.dataset.konfigurationType;
      var json = JSON.parse(edit_konfiguration_layer_neu(JSON.stringify(window.configuration), konfiguration_type));
      if (json) {
        window.configuration = json;
      }
      replacePopOver("config");
    }

    window.konfigurationLayerNeu = konfigurationLayerNeu;

  function moveOrDeleteKonfigurationField(event) {
    var konfiguration_type = event.target.dataset.konfigurationType;
    var style_id = event.target.dataset.konfigurationStyleId;
    var move_type = event.target.dataset.moveType;
    var json = JSON.parse(edit_konfiguration_move_layer(
      JSON.stringify(window.configuration), 
      konfiguration_type,
      style_id,
      move_type,
    ));
    if (json) {
      window.configuration = json;
    }
    replacePopOver("config");
  }

  window.moveOrDeleteKonfigurationField = moveOrDeleteKonfigurationField;

  function editKonfigurationTextField (event) {
    
    var textfield_type = event.target.dataset.konfigurationTextfield;
    var style_id = event.target.dataset.konfigurationStyleId;
    var value = event.target.value;
    
    switch (textfield_type) {
      case "map-basiskarte":
        window.configuration.map.basemap = value;
        break;
      case "map-dop-source":
        window.configuration.map.dop_source = value;
        break;      
      case "map-dop-layer":
        window.configuration.map.dop_layers = value;
        break;
      case "map-dgm-source":
        window.configuration.map.dgm_source = value;
        break;      
      case "map-dgm-layer":
        window.configuration.map.dgm_layers = value;
        break;
      case "map-style-name":
        window.configuration.style.ebenen[style_id].name = value;
        break;
      case "map-style-fillcolor":
        window.configuration.style.ebenen[style_id].fill_color = value;
        break;
      case "map-style-outlinecolor":
        window.configuration.style.ebenen[style_id].outline_color = value;
        break;
      case "map-style-outlinethickness":
        window.configuration.style.ebenen[style_id].outline_thickness = parseFloat(value);
        break;
      case "map-pdf-svg-grenzpunkt":
        window.configuration.pdf.grenzpunkt_svg = value;
        break;
      case "map-pdf-svg-pfeil":
        window.configuration.pdf.pfeil_svg = value;
        break;
      case "map-pdf-svg-nordpfeil":
        window.configuration.pdf.nordpfeil_svg = value;
        break;
      case "map-pdf-svg-gebaeude-loeschen":
        window.configuration.pdf.gebauede_loeschen_svg = value;
        break;
      case "map-pdf-nutzungsart-name":
        window.configuration.pdf.nutzungsarten[style_id].kuerzel = value;
        break;
      case "map-pdf-nutzungsart-fillcolor":
        window.configuration.pdf.nutzungsarten[style_id].fill_color = value;
        break;
      case "map-pdf-nutzungsart-outlinecolor":
        window.configuration.pdf.nutzungsarten[style_id].outline_color = value;
        break;
      case "map-pdf-nutzungsart-outlinethickness":
        window.configuration.pdf.nutzungsarten[style_id].outline_thickness = value;
        break;
      case "map-pdf-nutzungsart-outlinedash":
        window.configuration.pdf.nutzungsarten[style_id].outline_dash = value;
        break;
      case "map-pdf-nutzungsart-outline-overprint":
        window.configuration.pdf.nutzungsarten[style_id].outline_overprint = (value == "true");
        break;
      case "map-pdf-nutzungsart-pattern-svg":
        window.configuration.pdf.nutzungsarten[style_id].pattern_svg = value;
        break;
      case "map-pdf-nutzungsart-pattern-type":
        window.configuration.pdf.nutzungsarten[style_id].pattern_type = value;
        break;
      case "map-pdf-nutzungsart-beschriftung-schriftart":
        window.configuration.pdf.nutzungsarten[style_id].lagebez_ohne_hsnr.font = value;
        break;
      case "map-pdf-nutzungsart-beschriftung-schriftgroesse":
        window.configuration.pdf.nutzungsarten[style_id].lagebez_ohne_hsnr.fontsize = value;
        break;
      case "map-pdf-nutzungsart-beschriftung-schriftfarbe":
        window.configuration.pdf.nutzungsarten[style_id].lagebez_ohne_hsnr.color = value;
        break;
      
      default:
        break;
    }
  }

  window.editKonfigurationTextField = editKonfigurationTextField;

  function changeRiss(event) {
    var id = event.target.dataset.rissId;
    var event_id = event.target.dataset.inputId;
    var newval = parseFloat(event.target.value);
    if (event_id == "width") {
      window.risse[id].width_mm = newval;
    } else if (event_id == "height") {
      window.risse[id].height_mm = newval;
    } else if (event_id == "scale") {
      window.risse[id].scale = newval;
    }
    rerenderRisse();
  }

  window.changeRiss = changeRiss;

  function showHideFlurMarker(event) {

  }

  window.showHideFlurMarker = showHideFlurMarker;

  function showHideNordpfeil(event) {

  }

  window.showHideNordpfeil = showHideNordpfeil;

  function showHideLabel(event) {

  }

  window.showHideLabel = showHideLabel;

  function rissNeu(event) {
    let center = map.getCenter();
    window.risse["ri_" + Date.now()] = {
      lat: center.lat,
      lon: center.lng,
      crs: "latlon",
      width_mm: 297.0,
      height_mm: 420.0,
      scale: 3500.0,
    };
    active_rissgebiet = null;
    replaceProjectContent();
    rerenderRisse();  
  }
  window.rissNeu = rissNeu;

  function rissLoeschen(event) {
    var riss_id = event.target.dataset.rissId;
    delete window.risse[riss_id];
    replaceProjectContent();
    rerenderRisse();
  }
  window.rissLoeschen = rissLoeschen;

  function removeRisseLayer() {
      removeRissGebietLayer();
      removeRissGebietEinzeichnenLayer();
      for (var [riss_id, riss_objekte] of Object.entries(leaflet_risse)) {
        map.removeLayer(riss_objekte.leaflet_rect);
        map.removeLayer(riss_objekte.leaflet_rect_avoid);
        map.removeLayer(riss_objekte.leaflet_center_handle);
      }
      leaflet_risse = {};
    }

  window.PADDING = 16.5; // mm
  
  function rerenderRisse() {
    removeRisseLayer();
    removeRissGebietLayer();
    for (var [riss_id, riss_config] of Object.entries(window.risse)) {
      var rect = calculate_coords(
        riss_config.width_mm - (PADDING * 2.0), 
        riss_config.height_mm - (PADDING * 2.0), 
        riss_config.scale, 
        riss_config.lon, 
        riss_config.lat
      );
      var crs = null;
      if (window.split_flurstuecke_original) {
        crs = window.split_flurstuecke_original.crs;
      }
      var avoid_rect = JSON.parse(get_header_coords(JSON.stringify(riss_config), null));
      if (leaflet_risse[riss_id]) {
        leaflet_risse[riss_id].leaflet_rect.setBounds(rect.coords);
        leaflet_risse[riss_id].leaflet_rect_avoid.setBounds(avoid_rect.coords);
        leaflet_risse[riss_id].leaflet_center_handle.setLatLng({ lat:riss_config.lat,lng:riss_config.lon });
      } else {
        var map_extent = L.rectangle(rect.coords, {color: RISS_COLOR, weight: 2});
        var avoid_extent = L.rectangle(avoid_rect.coords, {color: AVOID_COLOR, weight: 1});
        var map_handle_center = L.marker({ lat:riss_config.lat,lng:riss_config.lon }, { draggable: true, icon: drag_icon_middle, riss_id: riss_id });
        map_handle_center.on('drag', function(event){ drag_handle(event) });
        leaflet_risse[riss_id] = {
          leaflet_rect: map_extent,
          leaflet_rect_avoid: avoid_extent,
          leaflet_center_handle: map_handle_center,
        };
        map_extent.addTo(map);
        avoid_extent.addTo(map);
        map_handle_center.addTo(map);
      }
      var myLayer = L.layerGroup([]);
      if (riss_config.rissgebiet) {
        var f = get_rissgebiet_geojson(
          JSON.stringify(riss_config.rissgebiet),
        );
        var rissgebiet = JSON.parse(f);
        var style_active = {
          "color": "#ffcc00",
          "fillColor": "#ffcc00",
          "weight": 0.0,
          "opacity": 0.5,
          "fillOpacity": 0.5
        };
        var style_inactive = {
          "color": "#fc03b6",
          "fillColor": "#000000",
          "weight": 4.0,
          "opacity": 0.5,
          "fillOpacity": 0.0
        };
        if (L.geoJSON) {
          myLayer.addLayer(L.geoJSON(rissgebiet, {
            "style": riss_id == active_rissgebiet ? style_active : style_inactive,
          }));
        } else if (L.geoJson) {
          myLayer.addLayer(L.geoJson(rissgebiet, {
            "style": riss_id == active_rissgebiet ? style_active : style_inactive,
          }));
        }
      }
      rissgebiet_layer = myLayer;
      if (rissgebiet_layer) {
        rissgebiet_layer.addTo(map);
      }
    }
  }

  window.rerenderRisse = rerenderRisse;
  window.removeRisseLayer = removeRisseLayer;

  function switchRissWh(event) {
    var id = event.target.dataset.rissId;
    if (window.risse[id]) {
      var tmp = window.risse[id].width_mm;
      window.risse[id].width_mm = window.risse[id].height_mm;
      window.risse[id].height_mm = tmp;
    }
    rerenderRisse();
    replaceProjectContent();
  }
  window.switchRissWh = switchRissWh;

  function drag_handle(event) {
    var riss_id = event.target.options.riss_id;
    var center_lat_lng = leaflet_risse[riss_id].leaflet_center_handle.getLatLng();
    var width = window.risse[riss_id].width_mm;
    var height = window.risse[riss_id].height_mm;
    var scale = window.risse[riss_id].scale;
    window.risse[riss_id].lat = center_lat_lng.lat;
    window.risse[riss_id].lon = center_lat_lng.lng;
    var rect = calculate_coords(width - (PADDING * 2.0), height - (PADDING * 2.0), scale, center_lat_lng.lng, center_lat_lng.lat);
    leaflet_risse[riss_id].leaflet_rect.setBounds(rect.coords);
    var crs = null;
    if (window.split_flurstuecke_original) {
      crs = window.split_flurstuecke_original.crs;
    }
    var avoid_rect = JSON.parse(get_header_coords(JSON.stringify(window.risse[riss_id]), null));
    leaflet_risse[riss_id].leaflet_rect_avoid.setBounds(avoid_rect.coords);
  }

  function projectInfoEdit(event) {
    var id = event.target.dataset.id;
    var newvalue = event.target.value;
    if (id == 'antragsnr') {
      window.info.antragsnr = newvalue;
    } else if (id == 'katasteramt') {
      window.info.katasteramt = newvalue;
    } else if (id == 'vermessungsstelle') {
      window.info.vermessungsstelle = newvalue;
    } else if (id == 'erstellt_durch') {
      window.info.erstellt_durch = newvalue;
    } else if (id == 'beruf_kuerzel') {
      window.info.beruf_kuerzel = newvalue;
    } else if (id == 'gemeinde') {
      window.info.gemeinde = newvalue;
    } else if (id == 'gemarkung') {
      window.info.gemarkung = newvalue;
    } else  if (id == 'bearbeitung_beendet_am') {
      window.info.bearbeitung_beendet_am = newvalue;
    } else  if (id == 'alkis_aktualitaet') {
      window.info.alkis_aktualitaet = newvalue;
    } else  if (id == 'orthofoto_datum') {
      window.info.orthofoto_datum = newvalue;
    } else  if (id == 'gis_feldbloecke_datum') {
      window.info.gis_feldbloecke_datum = newvalue;
    }
  }
  

  function onAenderungClicked(e) {
      var aenderung_id = e.target.feature.properties.newPolyId;
      console.log(aenderung_id);
      if (aenderung_id) {
        alert(aenderung_id);
      }
  }

  function aenderungClicked(feature, layer) {
        layer.on({
            dblclick: onAenderungClicked
        });
    }

  function reinitMapDrawnStaticLayers() {
    if (current_edit_layer != null) {
      map.removeLayer(current_edit_layer);
      current_edit_layer = null;
    }
    // if (uidata.tool != 'nutzung-einzeichnen') { return; }
    var newlayers = get_geojson_fuer_neue_polygone(
      JSON.stringify(window.aenderungen)
    );
    var newlayers = JSON.parse(newlayers);
    for (var k = 0; k < geojson_repaint_layers.length; k++) {
      var e = geojson_repaint_layers[k];
      map.removeLayer(e);
    }
    geojson_repaint_layers = [];
    for (var i = 0; i < newlayers.length; i++) {
      var l = newlayers[i];
      var nutzung_definiert = l.nutzung_definiert;
      var geojson = null;
      try {
        geojson = JSON.parse(l.geojson)
      } catch (error) {
        console.log(l);
        console.log(error);
        continue;
      }
      var color = nutzung_definiert ? "green" : "red" ;
      var myLayer = null;
      if (L.geoJson) {
        myLayer = L.geoJson(geojson, {
          "style": {
            "color": color,
            "fillColor": "#fff",
            "weight": 5,
            "opacity": 1.0,
            "fillOpacity": 0.3,
          },
          "onEachFeature": aenderungClicked
        });
      } else if (L.geoJSON) {
        myLayer = L.geoJSON(geojson, {
          "style": {
            "color": color,
            "fillColor": "#fff",
            "weight": 5,
            "opacity": 1.0,
            "fillOpacity": 0.3,
          },
          "onEachFeature": aenderungClicked
        });
      }

      if (myLayer == null) {
        continue;
      }

      myLayer.addTo(map);
      geojson_repaint_layers.push(myLayer);
    }
  }

  function zoomToGebaeudeLoeschen(event) {
    var gebaeude_id = event.target.dataset.gebaeudeId;
    if (!window.projectdata || window.projectdata == null) {
      return;
    }
    if (!window.projectdata.ebenen.AX_Gebaeude || window.projectdata.ebenen.AX_Gebaeude == null) {
      return;
    }
    var extent = search_for_gebauede(JSON.stringify(window.projectdata), gebaeude_id);
    var extent_json = JSON.parse(extent);
    highlightPolygon(extent_json);
  }
  
  function gebaeudeLoeschenUndo(event) {
      var gebaeude_id = event.target.dataset.gebaeudeId;
      var index = window.aenderungen.gebaeude_loeschen[gebaeude_id];
      if (index) {
        delete window.aenderungen.gebaeude_loeschen[gebaeude_id];
        reinitGebaeudeLoeschenLayer();
        replaceProjectContent();
      }
  }
  
  function nutzungsArtAendern(event) {
    var id = event.target.dataset.id;
    var kuerzel = event.target.value;
    if (!window.aenderungen || window.aenderungen == null) {
      return;
    }
    if (kuerzel == 'NOTDEFINED') {
      delete window.aenderungen.na_definiert;
    } else {
      window.aenderungen.na_definiert[id] = kuerzel;
    }
  }

  function changeSelectPolyNeu(event) {
    var id = event.target.dataset.id;
    var kuerzel = event.target.value;
    if (!window.aenderungen || window.aenderungen == null) {
      return;
    }
    if (kuerzel == 'NOTDEFINED') {
      window.aenderungen.na_polygone_neu[id].nutzung = null;
    } else {
      window.aenderungen.na_polygone_neu[id].nutzung = kuerzel;
    }
    reinitMapDrawnStaticLayers();
  }

  function zoomToPolyNeu(event) {
    var id = event.target.dataset.polyNeuId;
    if (!window.aenderungen || window.aenderungen == null) {
      return;
    }
    var extent = search_for_polyneu(JSON.stringify(window.aenderungen), id);
    var extent_json = JSON.parse(extent);
    highlightPolygon(extent_json);
  }
  
  function polyNeuUndo(event) {
    var id = event.target.dataset.polyNeuId;
    if (!window.aenderungen || window.aenderungen == null) {
      return;
    }
    delete window.aenderungen.na_polygone_neu[id];
    replaceProjectContent();
    reinitMapDrawnStaticLayers();
  }

  function colorFlurstuecke() {
    if (!window.csv_data) {
      return;
    }
    for (var k in window.csv_data) {
      var e = window.csv_data[k];
      for (var i = 0; i < e.length; i++) {
        var q = e[i];
        if (q.status == 'bleibt') {
          var e = document.getElementById('csv_flst_' + k);
          if (e) {
            e.style.background = '#3e3e58';
          }
          break;
        }
        if (q.status == 'aenderung-keine-benachrichtigung') {
          var e = document.getElementById('csv_flst_' + k);
          if (e) {
            e.style.background = '#ff9a5a';
          }
          break;
        }
        if (q.status == 'aenderung-mit-benachrichtigung') {
          var e = document.getElementById('csv_flst_' + k);
          if (e) {
            e.style.background = '#ff4545';
          }
          break;
        }
      }
    }
  }

  window.get_layer_style = get_layer_style;
  
  function splitNasDataOnEachFeatureClicked(e) {
    console.log("splitNasDataOnEachFeatureClicked");
    console.log(e.target);
    var flst_id = e.target.feature.properties.flurstueckskennzeichen;
    if (!flst_id) {
      return;
    }
    window.uidata.selected_edit_flst = flst_id.replace("_", "");
    console.log(flst_id.replace("_", ""));
    replaceProjectContent();
    var found = searchFlst(window.uidata.selected_edit_flst, window.projectdata);
    if (found) {
      selectFlst(window.uidata.selected_edit_flst);
      highlightPolygon(found.flst);
    } else {
      alert("Flurstück " + window.uidata.selected_edit_flst + " nicht in XML-Daten gefunden!");
    }
  }

  function splitNasDataOnEachFeature(feature, layer) {
        layer.on({
            dblclick: splitNasDataOnEachFeatureClicked
        });
    }

  function replaceDataNasXML() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = ".xml";

    input.onchange = e => { 
        var file = e.target.files[0]; 
        var reader = new FileReader();
        reader.readAsText(file,'UTF-8');
        reader.onload = readerEvent => {

          var converted = load_nas_xml(readerEvent.target.result, JSON.stringify(window.configuration));
          var parsed = null;
          try {
            parsed = JSON.parse(converted);
          } catch (error) {
            console.log(error);
          };
          
          window.xml_data = parsed.xml_parsed;
          window.nas_original = parsed.nas_original;
          window.projectdata = parsed.nas_projected;
          window.split_flurstuecke_original = parsed.nas_cut_original;
          window.split_flurstuecke = parsed.nas_cut_projected;
          window.parse_log = parsed.log;

          // remove old LeafLet layers
          for (var [layer_name, layer_obj] of Object.entries(geojson_layers)) {
            layers.removeLayer(layer_obj);
          }
          geojson_layers = [];
          var arr = JSON.parse(get_ebenen_darstellung(JSON.stringify(window.configuration)));
          for(var i = 0; i < arr.length; i++) {
            var ln = arr[i];
            var json = null;
            try {
              var f = get_geojson_fuer_ebene(JSON.stringify(window.projectdata), ln);
              json = f;
            } catch (error) {
              console.log(error);
              continue;
            }

            var geojson = null;
            try {
              geojson = JSON.parse(json);
            } catch (error) {
              console.log(error);
              console.log(json);
              continue;
            }
            if (geojson == null) {
              continue;
            }
            var layer_style = null;
            var ls = get_layer_style(JSON.stringify(window.configuration), ln);
            try {
                layer_style = JSON.parse(ls);
            } catch (e) {
              console.log(e);
              console.log(window.configuration);
              console.log(ln);
              console.log(ls);
              continue;
            }
            var myLayer = null;
            if (L.geoJson) {
              myLayer = L.geoJson(geojson, {
                "style": {
                  "color": layer_style.outline_color,
                  "fillColor": layer_style.fill_color,
                  "weight": layer_style.outline_thickness,
                  "opacity": 1.0,
                  "fillOpacity": 0.3,
                },
                "onEachFeature": splitNasDataOnEachFeature,
              });
            } else if (L.geoJSON) {
              myLayer = L.geoJSON(geojson, {
                "style": {
                  "color": layer_style.outline_color,
                  "fillColor": layer_style.fill_color,
                  "weight": layer_style.outline_thickness,
                  "opacity": 1.0,
                  "fillOpacity": 0.3,
                },
                "onEachFeature": splitNasDataOnEachFeature,
              });
            }
            
            if (myLayer == null) {
              continue;
            }

            if (L.tooltip) {
              var l = null;
              try {
                l = get_labels_fuer_ebene(JSON.stringify(window.projectdata), layer_style.name);
              } catch (error) {
                  console.error(error);
                  continue;
              }
              var labels = JSON.parse(l);
              for (var i = 0; i < labels.length; i++) {
              var e = labels[i];
              var t = L.tooltip([e.lat, e.lon], { 
                content: e.content, 
                direction: 'center', 
                permanent: true,
                interactive: true,
              });
              t.addTo(myLayer);
            }
            }
            myLayer.addTo(map);
            layers.addOverlay(myLayer, layer_style.name);
            geojson_layers.push(myLayer);
          }
        }
    }
    input.click();
}

  function selectFlst(id) {
    window.uidata.selected_edit_flst = id;
    replaceProjectContent();
    var v = document.getElementById('csv_flst_' + id);
    if (v) {
      v.scrollIntoView();
    }
  }

    function focusFlst(event) {
      var id = event.target.dataset.id;
      if (!window.projectdata || window.projectdata == null) {
        alert("Keine Daten geladen");
        return;
      }

      var found = searchFlst(id, window.projectdata);
      if (found) {
        selectFlst(id);
        highlightPolygon(found.flst);
      } else {
        alert("Flurstück " + id + " nicht in XML-Daten gefunden!");
      }
    }

    function searchFlst(id, pd) {
      var id = id.replace(/0+$/, "");
      // minimum 14 chars, prevent numbers such as "70" from being reduced to "7"
      if (id.length < 14) {
        for (let i = (14 - id.length); i > 0; i--) {
          id += "0";
        }
      }

      if (!pd) {
        return null;
      }

      for (var ebene_id in pd.ebenen) {
        var ebene = pd.ebenen[ebene_id];
        for (var i = 0; i < ebene.length; i++) {
          var flst = ebene[i];
          if (flst.attributes["flurstueckskennzeichen"] && flst.attributes["flurstueckskennzeichen"].startsWith(id)) {
            return {
              flst: flst,
              ebene: ebene_id,
            };
          }
        }
      }
      return null;
    }

    function newProjectFromCSV() {
      var input = document.createElement('input');
      input.type = 'file';
      input.multiple = 'true';
      input.accept = ".csv";

      input.onchange = e => { 
        if (e.target.files.length < 1) {
          return;
        }
        window.csv_data = {};
        for (var i = 0; i < e.target.files.length; i++) {
          var file = e.target.files[i];
          var reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = readerEvent => {
            var arrayBuffer = readerEvent.target.result;
            var array = new Uint8Array(arrayBuffer);
            var converted = parse_csv_dataset_to_json(
              array,
              "Flurstueck",
              "Nutzung",
              "Eigentuemer",
              "|",
              "true"
            );
            var json = JSON.parse(converted);
            for (var property in json) {
              window.csv_data[property] = json[property];
            }
            replaceProjectContent();
          }
        }
      }
      input.click();
    }

    function changeStatus(event) {
      var newstatus = event.target.value;
      var id = event.target.dataset.id;
      if (window.csv_data && window.csv_data[id]) {
        for (var i = 0; i < window.csv_data[id].length; i++) {
          window.csv_data[id][i].status = newstatus;
        }
      }
    }

    function changeNotiz(event) {
      var newnotiz = event.target.value;
      var id = event.target.dataset.id;
      if (window.csv_data && window.csv_data[id]) {
        for (var i = 0; i < window.csv_data[id].length; i++) {
          window.csv_data[id][i].notiz = newnotiz;
        }
      }
    }

    const downloadURL = (data, fileName) => {
        const a = document.createElement('a')
        a.href = data
        a.download = fileName
        document.body.appendChild(a)
        a.style.display = 'none'
        a.click()
        a.remove()
    }

    const downloadBlob = (data, fileName, mimeType) => {

        const blob = new Blob([data], {
            type: mimeType
        })

        const url = window.URL.createObjectURL(blob)

        downloadURL(url, fileName)

        setTimeout(() => window.URL.revokeObjectURL(url), 1000)
    }

    function saveProjectDataToFile() {
      if (!window.csv_data || window.csv_data == null) {
        window.csv_data = {};
      }
      var s = {
        info: window.info,
        risse: window.risse,
        csv: window.csv_data,
        aenderungen: window.aenderungen,
      };
      var b = "";
      try {
        b = format_savefile(
          JSON.stringify(window.info),
          JSON.stringify(window.risse),
          JSON.stringify(window.csv_data),
          JSON.stringify(window.aenderungen),
        );
      } catch (error) {
        b = JSON.stringify(s, null, 4);        
      }

      downloadBlob(b, window.info.antragsnr + ".json", 'application/octet-stream');
    }

    function loadProjectDataFromFile() {
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = ".json";

      input.onchange = e => { 
        if (e.target.files.length < 1) {
          return;
        }
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.readAsText(file,'UTF-8');
        reader.onload = readerEvent => {
          var json = JSON.parse(readerEvent.target.result);
          window.csv_data = json.csv;
          if (json.aenderungen) {
            window.aenderungen = json.aenderungen;
          }
          if (json.risse) {
            window.risse = json.risse;
          }
          if (json.info) {
            window.info = json.info;
          }
          replaceProjectContent();
          reinitMapDrawnStaticLayers();
        }
      }
      input.click();
    }

    function initializeOrUpdateMap() {
        L.Icon.Default.imagePath = 'path-to-your-leaflet-images-folder';
        if (map == null || map == undefined || !map) {
          map = L.map('map', {
            zoomControl: false,
            drawControl: true,
            maxNativeZoom: 25,
            maxZoom: 25,
            zoomSnap: 0,
          });
          map.doubleClickZoom.disable(); 
          map.setView([53.2467, 13.6045], 10);
          reinitDOPLayers();
          L.control.zoom({ position: 'bottomright' }).addTo(map);
          // addProblemGeoJSON(map);
          reinitMapDrawnStaticLayers();
        }
      }

    function reinitDOPLayers() {
      var basemap = L.tileLayer(window.configuration.map.basemap, {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', 
          maxNativeZoom: 25,
          maxZoom: 25,
      });
      var wms = L.tileLayer.wms(window.configuration.map.dop_source, {
          layers: window.configuration.map.dop_layers,
          maxNativeZoom: 25,
          maxZoom: 25,
      });
      var dgm = L.tileLayer.wms(window.configuration.map.dgm_source, {
          layers: window.configuration.map.dgm_layers,
          maxNativeZoom: 25,
          maxZoom: 25,
      });
      if (basemaps) {
        if (basemaps.OSM) {
          map.removeLayer(basemaps.OSM);
        }
        if (basemaps.DOP) {
          map.removeLayer(basemaps.DOP);
        }
      }
      basemaps = {
        OSM: basemap,
        DOP: wms,
        DGM: dgm,
      };
      if (layers) {
        layers.removeFrom(map);
      }
      layers = L.control.layers(basemaps);
      layers.addTo(map);
      if (basemaps.OSM) {
        try {
          basemaps.OSM.addTo(map);
        } catch (error) {
          console.error(error);
        }
      }
    }

    window.reinitDOPLayers = reinitDOPLayers;

    function exportLog() {
      if (!window.export_log) {
        return;
      }
      downloadBlob(JSON.stringify(window.export_log, null, 4), window.info.antragsnr + ".LOG.json", 'application/octet-stream')
    }
    window.exportLog = exportLog;

    function export_status_clear() {
      window.export_log = [];
    }

    window.export_status_clear = export_status_clear;

    function update_export_status(s) {
      if (!window.export_log) {
        window.export_log = [];
      }
      window.export_log.push(s);
    }

    window.update_export_status = update_export_status;

    function addProblemGeoJSON(map) {
      let j = JSON.parse(get_problem_geojson());
      let geojson1 = JSON.parse(j.geojson1);
      let geojson2 = JSON.parse(j.geojson2);
      let bounds = j.bounds;
      console.log(geojson1);
      console.log(geojson2);

      var ml = null;
      var style = {
        "color": "#ff0000",
        "fillColor": "#00ffcc",
        "weight": 1.0,
        "opacity": 0.8,
        "fillOpacity": 0.5
      };
      if (L.geoJSON) {
        ml = L.geoJSON(geojson1, {
          "style": style,
        });
      } else if (L.geoJson) {
        ml = L.geoJson(geojson1, {
          "style": style,
        });
      }
      map.addLayer(ml);

      var ml = null;
      var style = {
        "color": "#0000ff",
        "fillColor": "#000000",
        "weight": 3.0,
        "opacity": 0.8,
        "fillOpacity": 0.5
      };
      if (L.geoJSON) {
        ml = L.geoJSON(geojson2, {
          "style": style,
        });
      } else if (L.geoJson) {
        ml = L.geoJson(geojson2, {
          "style": style,
        });
      }
      map.addLayer(ml);

      map.fitBounds(bounds);
    }

    function replaceRibbon() {
      if (window.uidata.tab == '1' && (!window.split_flurstuecke || window.split_flurstuecke == null)) {
        if (window.projectdata == null) {
          alert("Keine Flurstücke zum Korrigieren geladen!");
        } else {
          alert("Flurstücke werden noch gesplittet, bitte warten...");
        }
        throw "test";
      }

      var d = document.getElementById("__application-ribbon");
      if (d) {
        d.innerHTML = ui_render_ribbon(JSON.stringify(window.uidata));
      }
    }

    function replacePopOverSearch(val) {
      let d = document.getElementById("__application_popover_search");
      d.innerHTML = ui_render_search_popover_content(val);
    }

    function closePopOverSearch() {
      let s = document.getElementById("__application_popover_search");
      if (s) {
        s.innerHTML = "";
      }
    }

    function replacePopOver(e) {
      let d = document.getElementById("__application_popover");
      if (d) {
        d.innerHTML = ui_render_popover_content(
          JSON.stringify(window.uidata),
          JSON.stringify(window.configuration),
        );
      }

      let q = document.getElementById("__application_main-overlay-container");
      if (q && window.uidata.popover_state == null) {
        q.style.zIndex = "999";
      } else {
        q.style.zIndex = "1";
      }
    }

    function toggleRenderOut() {
      if (window.uidata.render_out) {
        window.uidata.render_out = !window.uidata.render_out;
      } else {
        window.uidata.render_out = true;
      }
      replaceProjectContent();
    }

    window.toggleRenderOut = toggleRenderOut;

    function selectContent(id) {
      if (id == 0) {
        window.uidata.secondary_content = false;
      } else {
        window.uidata.secondary_content = true;
      }
      replaceProjectContent();
    }

    window.selectContent = selectContent;

    function replaceProjectContent() {
      let d = document.getElementById("__application_project_content");
      if (d) {
        var qq = ui_render_project_content(
          JSON.stringify(window.info),
          JSON.stringify(window.risse),
          JSON.stringify(window.uidata), 
          JSON.stringify(window.csv_data), 
          JSON.stringify(window.aenderungen),
          JSON.stringify(window.split_flurstuecke)
        );
        d.innerHTML = qq;
      }
      let q = document.getElementById("switch-content");
      if (q) {
        q.innerHTML = ui_render_switch_content(
          JSON.stringify(window.uidata), 
        );
      }
    }

    function removeAllExtraLayers() {
      removeGebaeudeLoeschenLayer();
      removeNutzungEinzeichnenLayer();
      removeRisseLayer();
      removeRissGebietLayer();
      removeRissGebietEinzeichnenLayer();
      if (highlight_layer) {
        map.removeLayer(highlight_layer);
        highlight_layer = null;
      }
    }

    function showHideRissGebiet(event) {
      if (window.uidata.tool != 'rissgebiet-zeichnen') {
        window.uidata.tool = 'rissgebiet-zeichnen';
        active_rissgebiet = event.target.dataset.rissId;
      } else {
        window.uidata.tool == null;
        active_rissgebiet = null;
      }
      rerenderRisse();
      reinitRissGebietLayer();
    }

    window.showHideRissGebiet = showHideRissGebiet;

    function reinitRissGebietLayer() {
      if (window.uidata.tool != 'rissgebiet-zeichnen') {
        return;
      }
      if (active_rissgebiet == null) {
        return;
      }
      if (!window.risse) {
        return;
      }
      var riss = window.risse[active_rissgebiet];
      if (!riss) {
        return;
      }

      guideLayers = [];
      var snapEdit = new L.EditToolbar.SnapEdit(map, {
          featureGroup: L.featureGroup([]),
          snapOptions: {
              guideLayers: guideLayers
          }
      });

      map.drawControl.setDrawingOptions({
          polyline: {
              guideLayers: guideLayers
          },
          polygon: {
              guideLayers: guideLayers,
              snapDistance: 5
          },
          marker: {
              guideLayers: guideLayers,
              snapVertices: false
          },
          rectangle: false,
          circle: false
      });

      map.on('draw:created', function(e) {
          var layer = e.layer;
          current_rissgebiet_layer = layer;
          map.addLayer(layer);
      });

      map.on('draw:drawstop', function (e) {
        if (e.layerType != 'polyline') {
          return;
        }
        var layers = e.target._layers;
        var keys = Object.keys(layers);
        var lastkey = keys[keys.length - 1];
        var l = layers[lastkey];
        if ((!l) || (!l.editing)) {
          return;
        }
        var points = l.editing.latlngs[0];
        if (points.length == 0) {
          return;
        }
        var f = JSON.parse(fixup_polyline(
          JSON.stringify(window.projectdata), 
          JSON.stringify(window.split_flurstuecke), 
          JSON.stringify(points),
        ));
        window.risse[active_rissgebiet].rissgebiet = f.poly;
        window.uidata.tool = null;
        rerenderRisse();
      });
    }

    function removeRissGebietEinzeichnenLayer() {
      if (current_rissgebiet_layer && current_rissgebiet_layer != null) {
        map.removeLayer(current_rissgebiet_layer);
      }
    }

    function removeRissGebietLayer() {
      if (rissgebiet_layer && rissgebiet_layer != null) {
        map.removeLayer(rissgebiet_layer);
      }
    }
    
    // Gebäude löschen
    function showHideGebaeudeLoeschenLayer() {
      removeAllExtraLayers();
      if (window.uidata.tool != 'gebaeude-loeschen') {
        window.uidata.tool = 'gebaeude-loeschen';
      } else {
        window.uidata.tool = null;
      }
      reinitGebaeudeLoeschenLayer();
      replaceRibbon();
    }

    function removeGebaeudeLoeschenLayer() {
      if (gebaeude_loeschen_layer && gebaeude_loeschen_layer != null) {
        map.removeLayer(gebaeude_loeschen_layer);
      }
    }

    function gebauedeClicked(e) {
      var gebaeude_id = e.target.feature.properties.gebaeude_id;
      var flst = JSON.parse(e.target.feature.properties.gebaeude_flst_id);
      if (!gebaeude_id) {
        return;
      }
      if (!flst) {
        return;
      }
      if (!window.aenderungen || !window.aenderungen.gebaeude_loeschen) {
        return;
      }
      var index = null;
      for (const [key, value] of Object.entries(window.aenderungen.gebaeude_loeschen)) {
        if (value == gebaeude_id) {
          index = key;
        }
      }
      if (index) {
        if (window.uidata.tool == 'gebaeude-loeschen') {
          delete window.aenderungen.gebaeude_loeschen[index];
        } else {
          alert("Bitte zuerst das Tool 'Gebäude löschen' einschalten.");
        }
      } else {
        window.aenderungen.gebaeude_loeschen["g_" + Date.now()] = { gebaeude_id: gebaeude_id, flst: flst }; // loeschen
      }
      reinitGebaeudeLoeschenLayer();
      replaceProjectContent();
    }

    function gebaeudeFeatureClick(feature, layer) {
        layer.on({
            dblclick: gebauedeClicked
        });
    }

    function gebaeudeStyle(feature) {
      var d = feature.properties.gebaeude_geloescht == "true";
      return {
          "color": d ? "#ff0000" : "#0000ff",
          "fillColor": d ? "#ff0000" : "#0000ff",
          "weight": 0.0,
          "opacity": 0.8,
          "fillOpacity": 0.8
        };
    }

    function reinitGebaeudeLoeschenLayer() {
      if (!window.uidata || window.uidata.tool != 'gebaeude-loeschen') {
        return;
      }
      var f = get_gebaeude_geojson_fuer_aktive_flst(
        JSON.stringify(window.projectdata),
        JSON.stringify(window.csv_data),
        JSON.stringify(window.aenderungen),
      );
      var gebaeude_geojson = JSON.parse(f);
      removeGebaeudeLoeschenLayer();
      var myLayer = null;
      
      if (L.geoJSON) {
        myLayer = L.geoJSON(gebaeude_geojson, {
          "style": gebaeudeStyle,
          "onEachFeature": gebaeudeFeatureClick
        });
      } else if (L.geoJson) {
        myLayer = L.geoJson(gebaeude_geojson, {
          "style": gebaeudeStyle,
          "onEachFeature": gebaeudeFeatureClick
        });
      }
      gebaeude_loeschen_layer = myLayer;
      map.addLayer(gebaeude_loeschen_layer);
    }

    // Nutzung einzeichnen

    function reinitNutzungEinzeichnenLayer() {
      if (!window.uidata || window.uidata.tool != 'nutzung-einzeichnen') {
        return;
      }

      var lines = JSON.parse(get_polyline_guides_in_current_bounds(
        JSON.stringify(window.split_flurstuecke),
        JSON.stringify(aenderungen),
        JSON.stringify(map.getBounds())
      ));

      for (var o = 0; o < guideLayers.length; o++) {
        map.removeLayer(guideLayers[o]);
      }

      guideLayers = [];
      for (var q = 0; q < lines.length; q++) {
        let pl = L.polyline(lines[q], {
            weight: 5,
            color: 'blue',
            opacity: 1.0
        });
        pl.addTo(map);
        guideLayers.push(pl)
      }

      var snapEdit = new L.EditToolbar.SnapEdit(map, {
          featureGroup: L.featureGroup([]),
          snapOptions: {
              guideLayers: guideLayers
          }
      });

      map.drawControl.setDrawingOptions({
          polyline: {
              guideLayers: guideLayers
          },
          polygon: {
              guideLayers: guideLayers,
              snapDistance: 5
          },
          marker: {
              guideLayers: guideLayers,
              snapVertices: false
          },
          rectangle: false,
          circle: false
      });

      map.on('draw:created', function(e) {
          var layer = e.layer;
          current_edit_layer = layer;
          map.addLayer(layer);
          guideLayers.push(layer);
      });

      map.on('draw:drawstop', function (e) {
        if (e.layerType != 'polyline') {
          return;
        }
        var layers = e.target._layers;
        var keys = Object.keys(layers);
        var lastkey = keys[keys.length - 1];
        var l = layers[lastkey];
        if ((!l) || (!l.editing)) {
          return;
        }
        var points = l.editing.latlngs[0];
        if (points.length == 0) {
          return;
        }
        var newpolyid = "np_" + Date.now();
        var f = JSON.parse(fixup_polyline(
          JSON.stringify(window.projectdata), 
          JSON.stringify(window.split_flurstuecke), 
          JSON.stringify(points),
        ));
        window.aenderungen.na_polygone_neu[newpolyid] = f;
        replaceProjectContent();
        reinitMapDrawnStaticLayers();
      });

    }

    function showHideNutzungEinzeichnenLayer() {
      removeAllExtraLayers();
      if (window.uidata.tool != 'nutzung-einzeichnen') {
        window.uidata.tool = 'nutzung-einzeichnen';
      } else {
        window.uidata.tool = null;
      }
      replaceRibbon();
      reinitNutzungEinzeichnenLayer();
    }

    function removeNutzungEinzeichnenLayer() {
      if (nutzung_einzeichnen_layer && nutzung_einzeichnen_layer != null) {
        map.removeLayer(nutzung_einzeichnen_layer);
      }
      nutzung_einzeichnen_layer = null;
      for (let i = 0; i < guideLayers.length; i++) {
        map.removeLayer(guideLayers[i]);
      }
      guideLayers = [];
    }

    // UI ----

    function selectTab(id) {
      window.uidata.tab = id;
      replaceRibbon();
      replaceProjectContent();
      reinitMapDrawnStaticLayers();
      if (id == 2) {
        rerenderRisse();
      } else {
        removeRisseLayer();
      }
    }

    function closePopOver() {
      window.uidata.popover_state = null;
      replacePopOver("config");
      closePopOverSearch();
      reinitDOPLayers();
    }

    function openHelp() {
      window.uidata.popover_state = "Help";
      replacePopOver("config");
    }

    function searchNA(event) {
      replacePopOverSearch(event.target.value);
    }

    function openInfo() {
      window.uidata.popover_state = "Info";
      replacePopOver("config");
    }

    function openConfiguration() {
      window.uidata.popover_state = { "Configuration": "allgemein" };
      replacePopOver("config");
    }

    function activateConfigurationView(event, id) {
      window.uidata.popover_state = { "Configuration": id };
      replacePopOver("config");
    }

    async function exportUebersicht(event) {
      if (!window.csv_data) {
        return;
      }
      if (!window.split_flurstuecke) {
        return;
      }
      var use_dgm = event.altKey;
      var pdf = await export_pdf_overview(
        JSON.stringify(window.configuration),
        JSON.stringify(window.nas_original),
        JSON.stringify(window.split_flurstuecke_original),
        JSON.stringify(window.csv_data),
        use_dgm,
      );
      downloadBlob(pdf, window.info.antragsnr + ".pdf", 'application/octet-stream');
    }

    function exportDavid() {
      if (!window.split_flurstuecke_original) {
        alert("Keine Projektdaten geladen!");
        return;
      }
      var xml = aenderungen_zu_david(
        JSON.stringify(window.aenderungen), 
        JSON.stringify(window.split_flurstuecke_original)
      );
      downloadBlob(xml, window.info.antragsnr + ".DAVID.FA.xml", 'text/xml');
    }

    async function exportGeoGraf(event) {
      
      var render_dgm = event.altKey;
      var render_hintergrund_vorschau = render_dgm || event.shiftKey;

      var zip = await aenderungen_zu_geograf(
        JSON.stringify(window.split_flurstuecke_original),
        JSON.stringify(window.nas_original),
        JSON.stringify(window.info),
        JSON.stringify(window.configuration),
        JSON.stringify(window.aenderungen),
        JSON.stringify(window.risse),
        JSON.stringify(window.csv_data),
        render_hintergrund_vorschau,
        render_dgm,
      );
      
      downloadBlob(zip, window.info.antragsnr + ".Aenderungen.GEOgraf.zip", 'application/octet-stream');
    }
    
    function exportFlstNachEigentuemer() {
        if (!window.csv_data) {
          return;
        }
        var xlsx = export_flst_id_nach_eigentuemer(JSON.stringify(window.csv_data));
        downloadBlob(xlsx, window.info.antragsnr + ".FlstNachEigentuemer.xlsx", 'application/octet-stream');
    }

    function exportAlleFlst() {
        if (!window.csv_data) {
          return;
        }
        var txt = export_alle_flst(JSON.stringify(window.csv_data));
        downloadBlob(txt, window.info.antragsnr + "Flurstuecke.txt", 'text/plain');
    }


    function lockUnlockPoly(event) {
      var id = '';
      if (event.target.dataset.polyNeuId) {
        id = event.target.dataset.polyNeuId;
      }

      console.log("lockunlock");
      var f = lock_unlock_poly(
        id, 
        JSON.stringify(window.aenderungen),
      );
      console.log("lockunlock done");
      console.log(f);

      var n = null;
      try {
        n = JSON.parse(f);
      } catch (error) {
        console.error(error);
        console.log(n);
        return;
      }

      if (n != null) {
        window.aenderungen = n.aenderungen;
        console.log(n.log);
        replaceProjectContent();
      }
    }

    window.lockUnlockPoly = lockUnlockPoly;
    
    function nutzungenSaeubern(event) {
      var id = '';
      if (event.target.dataset.nutzungId) {
        id = event.target.dataset.nutzungId;
      }
      if (!window.split_flurstuecke_original) {
        return;
      }

      var f = lib_nutzungen_saeubern(
        id, 
        JSON.stringify(window.aenderungen), 
        JSON.stringify(window.split_flurstuecke_original),
        JSON.stringify(window.nas_original),
        JSON.stringify(window.configuration),
      );

      var n = null;
      try {
        n = JSON.parse(f);
      } catch (error) {
        console.error(error);
        console.log(n);
        return;
      }

      if (n != null) {
        window.aenderungen = n.aenderungen;
        console.log(n.log);
        reinitMapDrawnStaticLayers();
      }
    }
    
    function cleanStage(id) {
      var n = null;
      console.log("JS: CLEANING STAGE " + id);
      var f = lib_get_aenderungen_clean(
        "" + id, 
        JSON.stringify(window.aenderungen), 
        JSON.stringify(window.split_flurstuecke_original),
        JSON.stringify(window.nas_original),
        JSON.stringify(window.configuration),
        JSON.stringify(window.csv_data),
      );
      try {
        n = JSON.parse(f);
      } catch (error) {
        console.error(error);
        console.log(n);
        console.log(f);
        return;
      }
      if (n != null) {
        window.aenderungen = n.aenderungen;
        console.log(n.log);
        replaceProjectContent();
      }
    }

    window.cleanStage = cleanStage;
    window.changeStatus = changeStatus;
    window.changeNotiz = changeNotiz;
    window.activateConfigurationView = activateConfigurationView;
    window.selectTab = selectTab;
    window.closePopOver = closePopOver;
    window.replacePopOver = replacePopOver;
    window.replaceProjectContent = replaceProjectContent;
    window.replaceRibbon = replaceRibbon;
    window.focusFlst = focusFlst;
    window.searchNA = searchNA;
    window.exportDavid = exportDavid;
    window.zoomToGebaeudeLoeschen = zoomToGebaeudeLoeschen;
    window.gebaeudeLoeschenUndo = gebaeudeLoeschenUndo;
    window.nutzungsArtAendern = nutzungsArtAendern;
    window.changeSelectPolyNeu = changeSelectPolyNeu;
    window.zoomToPolyNeu = zoomToPolyNeu;
    window.polyNeuUndo = polyNeuUndo;
    window.projectInfoEdit = projectInfoEdit;
    window.setInterval(colorFlurstuecke, 200);
    window.nutzungenSaeubern = nutzungenSaeubern;

    var tab_functions = {
        load_project: function(event) { loadProjectDataFromFile(); },
        create_project: function(event) { newProjectFromCSV(); },
        import_data: function(event) { replaceDataNasXML(); },
        save_project: function(event) { saveProjectDataToFile(); },
        open_help: function(event) { openHelp(); },
        open_info: function(event) { openInfo(); },
        open_configuration: function(event) { openConfiguration(); },
        export_uebersicht: async function(event) { await exportUebersicht(event); },
        export_flst_nach_eigentuemer: function(event) { exportFlstNachEigentuemer(); },
        export_alle_flst: function(event) { exportAlleFlst(); },
        export_geograf: async function(event) { await exportGeoGraf(event); },
        export_david: function(event) { exportDavid(); },
        gebaeude_loeschen: function(event) { showHideGebaeudeLoeschenLayer(); },
        nutzung_einzeichnen: function(event) { showHideNutzungEinzeichnenLayer(); },
        undo: function(event) { },
        redo: function(event) { },
    };
    window.tab_functions = tab_functions;
    window.initializeOrUpdateMap = initializeOrUpdateMap;

    init()
      .then(() => { 
        document.body.innerHTML = ui_render_entire_screen(
          JSON.stringify(window.info),
          JSON.stringify(window.risse),
          JSON.stringify(window.uidata),
          JSON.stringify(window.csv_data),
          JSON.stringify(window.aenderungen),
          JSON.stringify(window.configuration),
        );
        initializeOrUpdateMap(); // add leaflet map
      });
    </script>
  </head>
  <body>
  </body>
</html>
